---
title: "Football_script"
output: html_document
date: "2022-12-20"
---

```{r, include = FALSE}
library("worldfootballR")
library(tidyverse)
library(dplyr)
```

## Leagure URLs
```{r}
# get urls
GER_urls = fb_league_urls(country = "GER", gender = "M", season_end_year = 2021, tier = '1st')

# get match URLs
#match_urls = worldfootballR::fb_match_urls(country = "GER", gender = "M", tier = "1st", season_end_year = "2023")

match_urls = as.vector(httr::GET(worldfootballR::fb_match_urls(country = "GER", gender = "M", tier = "1st", season_end_year = "2023")[1])$url)
 
# get lineup for a match
lineups = worldfootballR::fb_match_lineups(match_url = match_urls[1], time_pause = 2)

# match results
match_info = worldfootballR::fb_match_results(country = "GER", gender = "M", tier = "1st", season_end_year = "2023")
```

## Player URLs
```{r}
# get player urls from ALL players
mapped_players <- player_dictionary_mapping()
dplyr::glimpse(mapped_players)

# get player URLs ONLY for players of a certain match
mapped_players_match = mapped_players[mapped_players$PlayerFBref %in% lineups[lineups$Min > 0,]$Player_Name, ] # players must have played at least 1 minute
```

## Player statistics
```{r}
# define function to scrape data from FBRef and skip if error occurs
scouting_FB_fun = function(x) {
  return(tryCatch(worldfootballR::fb_player_scouting_report(player_url = x, pos_versus = "primary", time_pause = 2), error=function(e) NULL))
}
# get statistics of players from certain match  
scouting_FB =  lapply(mapped_players_match$UrlFBref, scouting_FB_fun)
# remove empty data frames from list (if there are any)
scouting_FB_clean = scouting_FB[sapply(scouting_FB, function(x) !is.null(dim(x)[1]))]
# combine data frames
scouting_FB_c = plyr::rbind.fill(scouting_FB_clean)
# keep only information on last 365 days
scouting_FB_365 = scouting_FB_c %>% filter(scouting_period == "Last 365 Days")
# filter out some cols
scouting_FB_365 = select(scouting_FB_365, -c("StatGroup", "scouting_period"))    

# statistics of Players from TM
scouting_TM = sapply(mapped_players_match$UrlTmarkt, function(x) data.frame(worldfootballR::tm_player_bio(player_urls = x)))
# combine data frames
scouting_TM_c = plyr::rbind.fill(scouting_TM)
# rename player col
names(scouting_TM_c)[names(scouting_TM_c) == 'player_name'] <- 'Player'
# drop uninformative cols
scouting_TM_c = select(scouting_TM_c, c("Player", "age", "height", "current_club", "player_valuation", "max_player_valuation"))

# join TM and FBRef info
scouting_FB_TM = left_join(scouting_FB_365, scouting_TM_c)

# pattern matching to find similar names
a = sapply(scouting_FB_365$Player, function(x) 
  sapply(scouting_TM_c$Player, function(y) agrepl(x, y , max.distance=0.5)))


# make age numeric
scouting_FB_TM$age <- sapply(scouting_FB_TM$age, as.numeric)

# group by club, by age and by Statistic
group = scouting_FB_TM %>% 
  group_by(current_club, Versus, Statistic) %>% 
  summarise(Per90_mean = mean(Per90),
            Percentile_mean = mean(Percentile),
            BasedOnMinutes_mean = mean(BasedOnMinutes),
            age_mean = mean(age),
            height_mean = mean(height),
            player_valuation_mean = mean(player_valuation),
            max_player_valuation_mean = mean(max_player_valuation))
group = ungroup(group)

# remove new clubs of players

# compute ration home/away team

# add ground truth (who won --> maybe also how high)

# add some further club statistics (maybe last couple of games, general stuff like posession,...)


# this is how to make the df wide (later)
#group_wide = pivot_wider(data = group, names_from = c(current_club, Versus, Statistic), values_from = c(4:ncol(group)))
```
```{r}
library(dplyr)

desired <- NULL
grp <- 1
special <- function(x, y, grp) {
                if (nrow(y) < 1) {        # if y is empty return data
                     return(x)
                } else {
                     similar <- agrepl(y$s[1], y$s)      # find similar occurring strings
                     x <- rbind(x, y[similar,] %>% mutate(s=head(s,1)) %>% mutate(grp=grp))
                     y <- setdiff(y, y[similar,])
                     special(x, y, grp+1)
                }
           }

n = c(2, 3, 5)
s = c("ABBA", "ABA", "STING")
b = c(TRUE, "STING", "STRING")
df = data.frame(n,s,b)

desired <- special(desired,df,grp)


```





